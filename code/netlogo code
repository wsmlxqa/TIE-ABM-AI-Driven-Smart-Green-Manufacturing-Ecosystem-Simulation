globals [
  ; —————— 核心参数 ——————
  gamma           ; 知识外溢强度
  delta           ; AI节能效率
  epsilon         ; 清洁转型加速系数（提高）
  disruption-prob ; 外部冲击概率

  supply          ; 总供给
  demand          ; 市场需求
  price           ; 市场价格
  base-price      ; 基准价格
  elasticity      ; 价格弹性（提高）

  ; —————— 政策工具 ——————
  green-subsidy   ; 绿色补贴
  ai-innovation-subsidy ; AI创新补贴
  carbon-tax      ; 技术落后税
  energy-tax      ; 新增：基础能源税（用于基金）

  gov-budget      ; 政府预算
  budget-capacity ; 预算上限
  transition-fund ; 转型基金

  avg-ai-level    ; 平均AI水平
  avg-ai-gen      ; 平均AI代际

  ; —————— 容量上限 ——————
  max-manufacturers
  max-suppliers

  ; —————— 基础需求 ——————
  base-demand

  ; ✅ 记录上一次的平均代际
  prev-ai-gen
]

breed [ suppliers supplier ]
breed [ manufacturers manufacturer ]

manufacturers-own [
  competitiveness   ; ← 替换 energy
  ai-level       ; 0.0 ~ 1.0
  ai-generation ; G1, G2, G3...
]

suppliers-own [
  competitiveness   ; ← 替换 energy
]

patches-own [
  countdown      ; 绿色转型倒计时
]

to setup
  clear-all
  file-close-all

  ; 参数初始化（优化版）
  set gamma 0.012
  set delta 0.04
  set epsilon 0.001        ; ✅ 提高100倍，加速绿色转型
  set disruption-prob 0.02
  set base-price 1.8       ; ✅ 提高基准价格
  set elasticity 1.1       ; ✅ 提高弹性，需求更敏感
  set gov-budget 1000
  set budget-capacity 1000
  set transition-fund 0
  set base-demand 50

  set max-manufacturers 600
  set max-suppliers 3000

  set prev-ai-gen 1.0

  ; 创建地理空间
  ask patches [
    ifelse random-float 1 < 0.2 [
      set pcolor green
      set countdown 0
    ] [
      set pcolor brown
      set countdown random 60
    ]
  ]

  ; 创建初始企业
  create-suppliers 100 [
    setxy random-xcor random-ycor
    set shape "circle"
    set color yellow
    set label "S"
    set competitiveness 16   ; ← 替换 energy
  ]

  create-manufacturers 50 [
    setxy random-xcor random-ycor
    set shape "house"
    set color blue
    set label "G1"
    set competitiveness 30   ; ← 替换 energy
    set ai-level 0.0
    set ai-generation 1
  ]

  ; 创建CSV文件
  file-open "smart-green-manufacturing-data-v8.0 update.csv"
  file-print "tick,NumAIFactories,NumSuppliers,GreenZones,AvgAILevel,AvgAIGen,MarketPrice,GovBudget,TransitionFund,Supply,Demand"
  file-close

  print (word "🏭 Setup: AI Factories=" count manufacturers ", Suppliers=" count suppliers)
  reset-ticks
end

to go
  if not any? turtles [ stop ]

  ; —————— 市场机制增强版 ——————
  set supply count suppliers

  ; ✅ 需求 = 基础 × (1 + (代际-1)*0.8)^1.3 → 技术红利更强
  let tech-multiplier 1 + (max (list 0 (avg-ai-gen - 1))) * 0.8
  set demand base-demand * (tech-multiplier ^ 2.0)  ; 原为 ^1.0

  ; ✅ 价格 = 基准 × (需求/供给)^弹性 + 波动
  set price base-price * (demand / supply) ^ elasticity
  set price price * (0.98 + random-float 0.04)  ; ±2%波动
  set price precision (max (list 0.6 (min (list 2.5 price)))) 2

  ; —————— 计算平均AI水平与代际 ——————
  let ai-values [ai-level] of manufacturers
  let gen-values [ai-generation] of manufacturers
  set avg-ai-level ifelse-value (length ai-values > 0) [mean ai-values] [0.0]
  set avg-ai-gen   ifelse-value (length gen-values > 0) [mean gen-values] [1.0]
  set avg-ai-level precision avg-ai-level 3
  set avg-ai-gen   precision avg-ai-gen 2

  ; —————— 政策参数 ——————
  set green-subsidy green-subsidy-slider
  set ai-innovation-subsidy ai-innovation-slider
  set carbon-tax carbon-tax-slider
  set energy-tax 0.3     ; ✅ 新增：每企业征收基础能源税

  ; —————— 政府财政机制（优化）——————
  ; 对AI水平低的企业征税
  let num-low-ai count manufacturers with [ai-level < 0.5]
  let tax-revenue num-low-ai * carbon-tax * 0.8

  ; ✅ 新增：所有制造商缴纳基础能源税
  let energy-tax-revenue count manufacturers * energy-tax
  set transition-fund transition-fund + tax-revenue * 0.4 + energy-tax-revenue * 0.3

  ; 动态释放基金
  let green-ratio (count patches with [pcolor = green]) / count patches
  let fund-ratio transition-fund / 100
  let release-rate (0.15 + (1 - green-ratio) * 0.2) * (1 + min (list fund-ratio 2))
  let fund-release min (list (transition-fund * release-rate) (transition-fund * 0.9))
  set transition-fund transition-fund - fund-release

  set gov-budget gov-budget + fund-release
    set gov-budget max (list gov-budget 150)

  ; ✅ ✅ 动态补贴缩放：预算不足时自动降低补贴
  let subsidy-scale-factor ifelse-value (gov-budget < 200) [gov-budget / 200] [1]
  let adjusted-green-subsidy green-subsidy * subsidy-scale-factor
  let adjusted-ai-subsidy ai-innovation-subsidy * subsidy-scale-factor

  ; —————— 技术红利事件 ——————
  if ticks > 0 and ticks mod 100 = 0 [
    let gen-increase avg-ai-gen - prev-ai-gen
    if gen-increase > 0.8 [
      ask manufacturers [ set competitiveness competitiveness + 3 ]   ; ← 替换 energy
      set price price * 1.08
    ]
    set prev-ai-gen avg-ai-gen
  ]

  ; —————— 制造商行为 ——————
  ask manufacturers [
    ; 移动策略
    let target one-of patches in-radius 15 with [pcolor = brown]
    ifelse target != nobody [
      face target
      forward 1
    ] [
      right (random 51 - 25)
      forward 0.5
    ]

    ; 竞争力获取
    if pcolor = green [ set competitiveness competitiveness + 0.9 ]   ; ← 替换 energy
    if pcolor = brown [
      set countdown countdown - 5 * ai-level
      if countdown <= 0 [ set pcolor green set countdown 0 ]
    ]

    ; 技术外溢给供应商（修复版）
    let outer-myself self  ; 保存当前 manufacturer
    ask suppliers in-radius 3 [
      set competitiveness competitiveness + 0.25 * [ai-level] of outer-myself   ; ← 替换 energy
    ]

    ; 竞争力消耗
    set competitiveness competitiveness - 0.3 + ai-level * delta   ; ← 替换 energy

    ; —————— AI 代际升级（优化：保留部分技术）——————
    if competitiveness > 8 and ai-level > 0.7 [   ; ← 替换 energy
      let upgrade-cost 15 + ai-generation * 6
      if competitiveness > upgrade-cost [   ; ← 替换 energy
        set competitiveness competitiveness - upgrade-cost   ; ← 替换 energy
        set ai-generation ai-generation + 1
        ; ✅ 升级后保留部分技术，避免“降级”
        set ai-level [ai-level] of outer-myself * 0.6 + 0.3
        set color scale-color blue ai-generation 1 6
        set label (word "G" ai-generation)
      ]
    ]

    ; 常规AI升级
    if competitiveness > 4 and ai-level < 1.0 [   ; ← 替换 energy
      let cost 8 + ai-level * 12
      if competitiveness > cost [   ; ← 替换 energy
        set competitiveness competitiveness - cost   ; ← 替换 energy
        set ai-level min (list (ai-level + 0.09) 1.0)
        set color scale-color blue ai-level 0 1
        set label precision ai-level 1
      ]
    ]

    ; 知识扩散
    let partners manufacturers in-radius 7 with [ai-level > 0.1]
    if any? partners [
      let partner one-of partners
      let dist distance partner
      if random-float 1 < [ai-level] of partner / (1.5 + dist * 0.5) [
        set ai-level min (list (ai-level + 0.05) 1.0)
        set color scale-color blue ai-level 0 1
        set label precision ai-level 1
      ]
    ]

    ; 政策支持（使用缩放后补贴）
    if pcolor = green and gov-budget >= adjusted-green-subsidy and random-float 1 < 0.3 [  ; 原为0.35 → 0.3
      set competitiveness competitiveness + adjusted-green-subsidy   ; ← 替换 energy
      set gov-budget gov-budget - adjusted-green-subsidy
    ]

    if ai-level > 0.3 and gov-budget >= adjusted-ai-subsidy and random-float 1 < 0.3 [  ; 原为0.35 → 0.3
      set competitiveness competitiveness + adjusted-ai-subsidy   ; ← 替换 energy
      set gov-budget gov-budget - adjusted-ai-subsidy
    ]

    ; 技术落后税
    if ai-level < 0.4 and ticks > 50 [
      set competitiveness competitiveness - carbon-tax * 0.8   ; ← 替换 energy
    ]

    ; 繁殖
    if competitiveness > 10 and count manufacturers < max-manufacturers and random-float 1 < 0.015 [   ; ← 替换 energy
      set competitiveness competitiveness / 2   ; ← 替换 energy
      hatch-manufacturers 1 [
        set ai-level 0.3
        set ai-generation 1
        set color blue
        set label "G1"
        setxy xcor + random-float 2 ycor + random-float 2
        set competitiveness 15   ; ← 替换 energy
      ]
    ]

    if competitiveness < 0 [ die ]   ; ← 替换 energy
  ]

  ; —————— 供应商行为（增强价格抑制）——————
  ask suppliers [
    right (random 51 - 25)
    forward 0.7

    if pcolor = green [
      set competitiveness competitiveness + 1 + avg-ai-level * gamma   ; ← 替换 energy

      let base-prob 0.012
      let reproduction-prob base-prob * (price ^ 0.7)

      let market-saturation-factor (1 - (count suppliers / max-suppliers) ^ 0.3)
      let price-effect-factor (price / 1.0) ^ 0.5  ; ✅ 更敏感
      let density-factor (1 - min (list 1 (count suppliers / (max-suppliers * 1.0))))

      let final-prob reproduction-prob * density-factor * market-saturation-factor * price-effect-factor

      if competitiveness > 12 and random-float 1 < final-prob and (count suppliers / max list 1 count manufacturers) < 10 [   ; ← 替换 energy
        set competitiveness competitiveness / 2   ; ← 替换 energy
        hatch 1 [ forward 1 ]
      ]
    ]

    if pcolor = brown [ set competitiveness competitiveness - 0.65 ]   ; ← 替换 energy
    if competitiveness < 0 [ die ]   ; ← 替换 energy
  ]

  ; —————— 绿色转型加速 ——————
  ask patches with [pcolor = brown] [
    set countdown countdown - 0.1 + avg-ai-level * epsilon * 0.5
    if countdown <= 0 [ set pcolor green set countdown 0 ]
  ]

  ; —————— 外部冲击 ——————
  if random-float 1 < disruption-prob [
    ask n-of (0.04 * count patches) patches [
      set pcolor brown
      set countdown countdown + random 30
    ]
    ask manufacturers [ set competitiveness competitiveness * 0.75 ]   ; ← 替换 energy
  ]

  ; —————— 数据记录（降低频率）——————
  if ticks mod 20 = 0 [  ; 原为 mod 10
    print (word "📊 T=" ticks
      " M=" count manufacturers
      " S=" count suppliers
      " Green=" count patches with [pcolor = green]
      " AI-L=" precision avg-ai-level 2
      " Gen=" precision avg-ai-gen 1
      " Price=" precision price 2
      " Budget=" precision gov-budget 0
      " Fund=" precision transition-fund 0)

    file-open "smart-green-manufacturing-data-v8.0 update.csv"
    file-print (word ticks "," count manufacturers "," count suppliers ","
                count patches with [pcolor = green] "," precision avg-ai-level 2 ","
                precision avg-ai-gen 2 "," precision price 2 ","
                precision gov-budget 0 "," precision transition-fund 0 ","
                supply "," demand)
    file-close
  ]

  tick
end
