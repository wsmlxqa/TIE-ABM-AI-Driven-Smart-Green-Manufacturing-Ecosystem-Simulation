globals [
  ; â€”â€”â€”â€”â€”â€” æ ¸å¿ƒå‚æ•° â€”â€”â€”â€”â€”â€”
  gamma           ; çŸ¥è¯†å¤–æº¢å¼ºåº¦
  delta           ; AIèŠ‚èƒ½æ•ˆç‡
  epsilon         ; æ¸…æ´è½¬å‹åŠ é€Ÿç³»æ•°ï¼ˆæé«˜ï¼‰
  disruption-prob ; å¤–éƒ¨å†²å‡»æ¦‚ç‡

  supply          ; æ€»ä¾›ç»™
  demand          ; å¸‚åœºéœ€æ±‚
  price           ; å¸‚åœºä»·æ ¼
  base-price      ; åŸºå‡†ä»·æ ¼
  elasticity      ; ä»·æ ¼å¼¹æ€§ï¼ˆæé«˜ï¼‰

  ; â€”â€”â€”â€”â€”â€” æ”¿ç­–å·¥å…· â€”â€”â€”â€”â€”â€”
  green-subsidy   ; ç»¿è‰²è¡¥è´´
  ai-innovation-subsidy ; AIåˆ›æ–°è¡¥è´´
  carbon-tax      ; æŠ€æœ¯è½åç¨
  energy-tax      ; æ–°å¢ï¼šåŸºç¡€èƒ½æºç¨ï¼ˆç”¨äºåŸºé‡‘ï¼‰

  gov-budget      ; æ”¿åºœé¢„ç®—
  budget-capacity ; é¢„ç®—ä¸Šé™
  transition-fund ; è½¬å‹åŸºé‡‘

  avg-ai-level    ; å¹³å‡AIæ°´å¹³
  avg-ai-gen      ; å¹³å‡AIä»£é™…

  ; â€”â€”â€”â€”â€”â€” å®¹é‡ä¸Šé™ â€”â€”â€”â€”â€”â€”
  max-manufacturers
  max-suppliers

  ; â€”â€”â€”â€”â€”â€” åŸºç¡€éœ€æ±‚ â€”â€”â€”â€”â€”â€”
  base-demand

  ; âœ… è®°å½•ä¸Šä¸€æ¬¡çš„å¹³å‡ä»£é™…
  prev-ai-gen
]

breed [ suppliers supplier ]
breed [ manufacturers manufacturer ]

manufacturers-own [
  competitiveness   ; â† æ›¿æ¢ energy
  ai-level       ; 0.0 ~ 1.0
  ai-generation ; G1, G2, G3...
]

suppliers-own [
  competitiveness   ; â† æ›¿æ¢ energy
]

patches-own [
  countdown      ; ç»¿è‰²è½¬å‹å€’è®¡æ—¶
]

to setup
  clear-all
  file-close-all

  ; å‚æ•°åˆå§‹åŒ–ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
  set gamma 0.012
  set delta 0.04
  set epsilon 0.001        ; âœ… æé«˜100å€ï¼ŒåŠ é€Ÿç»¿è‰²è½¬å‹
  set disruption-prob 0.02
  set base-price 1.8       ; âœ… æé«˜åŸºå‡†ä»·æ ¼
  set elasticity 1.1       ; âœ… æé«˜å¼¹æ€§ï¼Œéœ€æ±‚æ›´æ•æ„Ÿ
  set gov-budget 1000
  set budget-capacity 1000
  set transition-fund 0
  set base-demand 50

  set max-manufacturers 600
  set max-suppliers 3000

  set prev-ai-gen 1.0

  ; åˆ›å»ºåœ°ç†ç©ºé—´
  ask patches [
    ifelse random-float 1 < 0.2 [
      set pcolor green
      set countdown 0
    ] [
      set pcolor brown
      set countdown random 60
    ]
  ]

  ; åˆ›å»ºåˆå§‹ä¼ä¸š
  create-suppliers 100 [
    setxy random-xcor random-ycor
    set shape "circle"
    set color yellow
    set label "S"
    set competitiveness 16   ; â† æ›¿æ¢ energy
  ]

  create-manufacturers 50 [
    setxy random-xcor random-ycor
    set shape "house"
    set color blue
    set label "G1"
    set competitiveness 30   ; â† æ›¿æ¢ energy
    set ai-level 0.0
    set ai-generation 1
  ]

  ; åˆ›å»ºCSVæ–‡ä»¶
  file-open "smart-green-manufacturing-data-v8.0 update.csv"
  file-print "tick,NumAIFactories,NumSuppliers,GreenZones,AvgAILevel,AvgAIGen,MarketPrice,GovBudget,TransitionFund,Supply,Demand"
  file-close

  print (word "ğŸ­ Setup: AI Factories=" count manufacturers ", Suppliers=" count suppliers)
  reset-ticks
end

to go
  if not any? turtles [ stop ]

  ; â€”â€”â€”â€”â€”â€” å¸‚åœºæœºåˆ¶å¢å¼ºç‰ˆ â€”â€”â€”â€”â€”â€”
  set supply count suppliers

  ; âœ… éœ€æ±‚ = åŸºç¡€ Ã— (1 + (ä»£é™…-1)*0.8)^1.3 â†’ æŠ€æœ¯çº¢åˆ©æ›´å¼º
  let tech-multiplier 1 + (max (list 0 (avg-ai-gen - 1))) * 0.8
  set demand base-demand * (tech-multiplier ^ 2.0)  ; åŸä¸º ^1.0

  ; âœ… ä»·æ ¼ = åŸºå‡† Ã— (éœ€æ±‚/ä¾›ç»™)^å¼¹æ€§ + æ³¢åŠ¨
  set price base-price * (demand / supply) ^ elasticity
  set price price * (0.98 + random-float 0.04)  ; Â±2%æ³¢åŠ¨
  set price precision (max (list 0.6 (min (list 2.5 price)))) 2

  ; â€”â€”â€”â€”â€”â€” è®¡ç®—å¹³å‡AIæ°´å¹³ä¸ä»£é™… â€”â€”â€”â€”â€”â€”
  let ai-values [ai-level] of manufacturers
  let gen-values [ai-generation] of manufacturers
  set avg-ai-level ifelse-value (length ai-values > 0) [mean ai-values] [0.0]
  set avg-ai-gen   ifelse-value (length gen-values > 0) [mean gen-values] [1.0]
  set avg-ai-level precision avg-ai-level 3
  set avg-ai-gen   precision avg-ai-gen 2

  ; â€”â€”â€”â€”â€”â€” æ”¿ç­–å‚æ•° â€”â€”â€”â€”â€”â€”
  set green-subsidy green-subsidy-slider
  set ai-innovation-subsidy ai-innovation-slider
  set carbon-tax carbon-tax-slider
  set energy-tax 0.3     ; âœ… æ–°å¢ï¼šæ¯ä¼ä¸šå¾æ”¶åŸºç¡€èƒ½æºç¨

  ; â€”â€”â€”â€”â€”â€” æ”¿åºœè´¢æ”¿æœºåˆ¶ï¼ˆä¼˜åŒ–ï¼‰â€”â€”â€”â€”â€”â€”
  ; å¯¹AIæ°´å¹³ä½çš„ä¼ä¸šå¾ç¨
  let num-low-ai count manufacturers with [ai-level < 0.5]
  let tax-revenue num-low-ai * carbon-tax * 0.8

  ; âœ… æ–°å¢ï¼šæ‰€æœ‰åˆ¶é€ å•†ç¼´çº³åŸºç¡€èƒ½æºç¨
  let energy-tax-revenue count manufacturers * energy-tax
  set transition-fund transition-fund + tax-revenue * 0.4 + energy-tax-revenue * 0.3

  ; åŠ¨æ€é‡Šæ”¾åŸºé‡‘
  let green-ratio (count patches with [pcolor = green]) / count patches
  let fund-ratio transition-fund / 100
  let release-rate (0.15 + (1 - green-ratio) * 0.2) * (1 + min (list fund-ratio 2))
  let fund-release min (list (transition-fund * release-rate) (transition-fund * 0.9))
  set transition-fund transition-fund - fund-release

  set gov-budget gov-budget + fund-release
    set gov-budget max (list gov-budget 150)

  ; âœ… âœ… åŠ¨æ€è¡¥è´´ç¼©æ”¾ï¼šé¢„ç®—ä¸è¶³æ—¶è‡ªåŠ¨é™ä½è¡¥è´´
  let subsidy-scale-factor ifelse-value (gov-budget < 200) [gov-budget / 200] [1]
  let adjusted-green-subsidy green-subsidy * subsidy-scale-factor
  let adjusted-ai-subsidy ai-innovation-subsidy * subsidy-scale-factor

  ; â€”â€”â€”â€”â€”â€” æŠ€æœ¯çº¢åˆ©äº‹ä»¶ â€”â€”â€”â€”â€”â€”
  if ticks > 0 and ticks mod 100 = 0 [
    let gen-increase avg-ai-gen - prev-ai-gen
    if gen-increase > 0.8 [
      ask manufacturers [ set competitiveness competitiveness + 3 ]   ; â† æ›¿æ¢ energy
      set price price * 1.08
    ]
    set prev-ai-gen avg-ai-gen
  ]

  ; â€”â€”â€”â€”â€”â€” åˆ¶é€ å•†è¡Œä¸º â€”â€”â€”â€”â€”â€”
  ask manufacturers [
    ; ç§»åŠ¨ç­–ç•¥
    let target one-of patches in-radius 15 with [pcolor = brown]
    ifelse target != nobody [
      face target
      forward 1
    ] [
      right (random 51 - 25)
      forward 0.5
    ]

    ; ç«äº‰åŠ›è·å–
    if pcolor = green [ set competitiveness competitiveness + 0.9 ]   ; â† æ›¿æ¢ energy
    if pcolor = brown [
      set countdown countdown - 5 * ai-level
      if countdown <= 0 [ set pcolor green set countdown 0 ]
    ]

    ; æŠ€æœ¯å¤–æº¢ç»™ä¾›åº”å•†ï¼ˆä¿®å¤ç‰ˆï¼‰
    let outer-myself self  ; ä¿å­˜å½“å‰ manufacturer
    ask suppliers in-radius 3 [
      set competitiveness competitiveness + 0.25 * [ai-level] of outer-myself   ; â† æ›¿æ¢ energy
    ]

    ; ç«äº‰åŠ›æ¶ˆè€—
    set competitiveness competitiveness - 0.3 + ai-level * delta   ; â† æ›¿æ¢ energy

    ; â€”â€”â€”â€”â€”â€” AI ä»£é™…å‡çº§ï¼ˆä¼˜åŒ–ï¼šä¿ç•™éƒ¨åˆ†æŠ€æœ¯ï¼‰â€”â€”â€”â€”â€”â€”
    if competitiveness > 8 and ai-level > 0.7 [   ; â† æ›¿æ¢ energy
      let upgrade-cost 15 + ai-generation * 6
      if competitiveness > upgrade-cost [   ; â† æ›¿æ¢ energy
        set competitiveness competitiveness - upgrade-cost   ; â† æ›¿æ¢ energy
        set ai-generation ai-generation + 1
        ; âœ… å‡çº§åä¿ç•™éƒ¨åˆ†æŠ€æœ¯ï¼Œé¿å…â€œé™çº§â€
        set ai-level [ai-level] of outer-myself * 0.6 + 0.3
        set color scale-color blue ai-generation 1 6
        set label (word "G" ai-generation)
      ]
    ]

    ; å¸¸è§„AIå‡çº§
    if competitiveness > 4 and ai-level < 1.0 [   ; â† æ›¿æ¢ energy
      let cost 8 + ai-level * 12
      if competitiveness > cost [   ; â† æ›¿æ¢ energy
        set competitiveness competitiveness - cost   ; â† æ›¿æ¢ energy
        set ai-level min (list (ai-level + 0.09) 1.0)
        set color scale-color blue ai-level 0 1
        set label precision ai-level 1
      ]
    ]

    ; çŸ¥è¯†æ‰©æ•£
    let partners manufacturers in-radius 7 with [ai-level > 0.1]
    if any? partners [
      let partner one-of partners
      let dist distance partner
      if random-float 1 < [ai-level] of partner / (1.5 + dist * 0.5) [
        set ai-level min (list (ai-level + 0.05) 1.0)
        set color scale-color blue ai-level 0 1
        set label precision ai-level 1
      ]
    ]

    ; æ”¿ç­–æ”¯æŒï¼ˆä½¿ç”¨ç¼©æ”¾åè¡¥è´´ï¼‰
    if pcolor = green and gov-budget >= adjusted-green-subsidy and random-float 1 < 0.3 [  ; åŸä¸º0.35 â†’ 0.3
      set competitiveness competitiveness + adjusted-green-subsidy   ; â† æ›¿æ¢ energy
      set gov-budget gov-budget - adjusted-green-subsidy
    ]

    if ai-level > 0.3 and gov-budget >= adjusted-ai-subsidy and random-float 1 < 0.3 [  ; åŸä¸º0.35 â†’ 0.3
      set competitiveness competitiveness + adjusted-ai-subsidy   ; â† æ›¿æ¢ energy
      set gov-budget gov-budget - adjusted-ai-subsidy
    ]

    ; æŠ€æœ¯è½åç¨
    if ai-level < 0.4 and ticks > 50 [
      set competitiveness competitiveness - carbon-tax * 0.8   ; â† æ›¿æ¢ energy
    ]

    ; ç¹æ®–
    if competitiveness > 10 and count manufacturers < max-manufacturers and random-float 1 < 0.015 [   ; â† æ›¿æ¢ energy
      set competitiveness competitiveness / 2   ; â† æ›¿æ¢ energy
      hatch-manufacturers 1 [
        set ai-level 0.3
        set ai-generation 1
        set color blue
        set label "G1"
        setxy xcor + random-float 2 ycor + random-float 2
        set competitiveness 15   ; â† æ›¿æ¢ energy
      ]
    ]

    if competitiveness < 0 [ die ]   ; â† æ›¿æ¢ energy
  ]

  ; â€”â€”â€”â€”â€”â€” ä¾›åº”å•†è¡Œä¸ºï¼ˆå¢å¼ºä»·æ ¼æŠ‘åˆ¶ï¼‰â€”â€”â€”â€”â€”â€”
  ask suppliers [
    right (random 51 - 25)
    forward 0.7

    if pcolor = green [
      set competitiveness competitiveness + 1 + avg-ai-level * gamma   ; â† æ›¿æ¢ energy

      let base-prob 0.012
      let reproduction-prob base-prob * (price ^ 0.7)

      let market-saturation-factor (1 - (count suppliers / max-suppliers) ^ 0.3)
      let price-effect-factor (price / 1.0) ^ 0.5  ; âœ… æ›´æ•æ„Ÿ
      let density-factor (1 - min (list 1 (count suppliers / (max-suppliers * 1.0))))

      let final-prob reproduction-prob * density-factor * market-saturation-factor * price-effect-factor

      if competitiveness > 12 and random-float 1 < final-prob and (count suppliers / max list 1 count manufacturers) < 10 [   ; â† æ›¿æ¢ energy
        set competitiveness competitiveness / 2   ; â† æ›¿æ¢ energy
        hatch 1 [ forward 1 ]
      ]
    ]

    if pcolor = brown [ set competitiveness competitiveness - 0.65 ]   ; â† æ›¿æ¢ energy
    if competitiveness < 0 [ die ]   ; â† æ›¿æ¢ energy
  ]

  ; â€”â€”â€”â€”â€”â€” ç»¿è‰²è½¬å‹åŠ é€Ÿ â€”â€”â€”â€”â€”â€”
  ask patches with [pcolor = brown] [
    set countdown countdown - 0.1 + avg-ai-level * epsilon * 0.5
    if countdown <= 0 [ set pcolor green set countdown 0 ]
  ]

  ; â€”â€”â€”â€”â€”â€” å¤–éƒ¨å†²å‡» â€”â€”â€”â€”â€”â€”
  if random-float 1 < disruption-prob [
    ask n-of (0.04 * count patches) patches [
      set pcolor brown
      set countdown countdown + random 30
    ]
    ask manufacturers [ set competitiveness competitiveness * 0.75 ]   ; â† æ›¿æ¢ energy
  ]

  ; â€”â€”â€”â€”â€”â€” æ•°æ®è®°å½•ï¼ˆé™ä½é¢‘ç‡ï¼‰â€”â€”â€”â€”â€”â€”
  if ticks mod 20 = 0 [  ; åŸä¸º mod 10
    print (word "ğŸ“Š T=" ticks
      " M=" count manufacturers
      " S=" count suppliers
      " Green=" count patches with [pcolor = green]
      " AI-L=" precision avg-ai-level 2
      " Gen=" precision avg-ai-gen 1
      " Price=" precision price 2
      " Budget=" precision gov-budget 0
      " Fund=" precision transition-fund 0)

    file-open "smart-green-manufacturing-data-v8.0 update.csv"
    file-print (word ticks "," count manufacturers "," count suppliers ","
                count patches with [pcolor = green] "," precision avg-ai-level 2 ","
                precision avg-ai-gen 2 "," precision price 2 ","
                precision gov-budget 0 "," precision transition-fund 0 ","
                supply "," demand)
    file-close
  ]

  tick
end
